# !/bin/sh
#
# PROVIDE: jenkins
# REQUIRE: NETWORKING
# KEYWORD: shutdown

JENKINS_MASTER=http://dotnet-ci.cloudapp.net

start(){
 USER=dotnet-bot
 HOSTNAME=<hostname>
 # Make /mnt/j and make it writeable
 chmod 777 /mnt/tmpdrive/
 mkdir /mnt/tmpdrive/j
 /usr/local/bin/wget $JENKINS_MASTER/jnlpJars/slave.jar -O /home/$USER/slave.jar
 dotnetbotSecret=
 START="nohup /usr/local/bin/java -jar /home/$USER/slave.jar -jnlpUrl $JENKINS_MASTER/computer/$HOSTNAME/slave-agent.jnlp -jnlpCredentials dotnet-bot:<dotnet-bot creds>"
 echo $START
 nohup /usr/bin/su -m $USER -c "$START" > /home/$USER/jenkins.log 2>&1 &
 echo "Jenkins slave started"
}

stop(){
 kill `ps | grep dotnet-ci | grep slave | grep -v grep | awk '{ print $1 }'`
 echo "Jenkins slave stopped"
}

status(){
 numproc=`ps | grep dotnet-ci | grep slave | grep -v grep | awk  | wc -l`
 if [ $numproc -gt 0 ]; then
  echo "Jenkins slave is running..."
  else
  echo "Jenkins slave is stopped..."
 fi
}

restart(){
  stop
  start
}

# See how we were called.
case "$1" in
start)
 start
 ;;
stop)
 stop
 ;;
status)
 status
 ;;
restart)
 restart
 ;;
*)
 exit 1
esac

exit 0
